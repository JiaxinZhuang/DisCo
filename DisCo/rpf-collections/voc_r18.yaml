# 训练任务的名字, 对应机智平台上的任务名称, 同时对应 机智平台上的模型文件名字, 对于同样训练代码, 最好使用同样的名字
# 名字不能有空格,非'^[A-Z|a-z|0-9|_|-|\.]{2,48}$'的特殊字符.
name: voc_mocov2_r18

#任务跑的机器数目 和 每个机器的GPU个数
worker_num: 1
gpu_num_per_worker: 8

#机智平台上的业务标示, 通过rpf-jcli query 的 free_gpu 查看业务当前空余资源
jizhi_business: youtu_vehicle

# 数据集， 从http://jizhi.oa.com/#/Dataset 获得
dataset: youtu-reid-rw

#使用的镜像名字,参考 https://git.code.oa.com/yt-rapidflow/docker_images
image_full_name: "mirrors.tencent.com/rpf/pytorch:1.6.0"

# 任务结束后是否释放资源，对于调试任务保留现场，设置为True
release_ip: False

# ------------
# lightrun 启动命令配置 参考： https://git.code.oa.com/yt-rapidflow/lightrun    
## 日志存储目录, 对于微信集群 设置为 task_out
log_dir: ./logs
#log_level: INFO

## 自定义环境变量
envs: 
  - "NCCL_DEBUG=INFO"
  - "NCCL_LAUNCH_MODE=GROUP"
  - "NCCL_DEBUG_SUBSYS=INIT"

## 启动初始化命令
# setup：
# - "nvidia-smi"

## command 执行方式  mpi, hvd, rpf_mpi, multi_node, multi_gpu
template: multi_node

setup:
    - "cp -r /youtu-reid/jiaxzhuang/data/ft_local/VOCdevkit/* /dev/shm/"
    #- "cp -r /youtu_pedestrian_detection/voc/VOC2012 /dev/shm/"
#setup:
    #- "cp -r /youtu-public/imagenet/ILSVRC/Data/CLS-LOC/train  /dev/shm/"
     #- "cp -r /youtu-public/imagenet/ILSVRC/Data/CLS-LOC/val  /dev/shm/"
#     - "yum --enablerepo=tlinux-testing install tlinux-release-gcc-update && yum remove tlinux12-compat compat-gcc-44-c++ && yum update gcc"

## 训练执行命令
command:
    - "export PYTHONWARNINGS='ignore:semaphore_tracker:UserWarning'"
    - "export http_proxy='http://star-proxy.oa.com:3128'"
    - "export https_proxy='http://star-proxy.oa.com:3128'"
    - "export DETECTRON2_DATASETS=/dev/shm"
    - "pip install /youtu-reid/jiaxzhuang/acmm/detectron2-0.4+cu101-cp36-cp36m-linux_x86_64.whl"
    - "cd detection"
    - "python3 convert-pretrain-to-detectron2.py /apdcephfs/private_jiaxzhuang/shared_info/jiaxzhuang/MoCoV2_ResNet18_1e3d941c_8/ckpt/checkpoint_0199.pth.tar ./output.pkl"
    - "python3 train_net.py --config-file configs/pascal_voc_R_50_C4_24k_moco.yaml --num-gpus 8 --resume MODEL.RESNETS.DEPTH 18 MODEL.RESNETS.RES2_OUT_CHANNELS 64 2>&1 | tee ../logs/std.log"
      #- "export DETECTRON2_DATASETS=/youtu-reid/jiaxzhuang/data/ft_local/VOCdevkit/"
      #- "export DETECTRON2_DATASETS=/youtu-reid/jiaxzhuang/data/ft_local/VOCdevkit/"
